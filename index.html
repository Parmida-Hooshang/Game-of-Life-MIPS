<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Game of Life: MIPS</title>

		<meta name="description" content="A MIPS assembly implementation of Conway's Game of Life ">
		<meta name="author" content="Parmida Hooshang & Mohammad hassan Liaghat">

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/dracula.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
	</head>

	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h2>Hello!</h2>
				</section>

				<section>
					Let's begin!
				</section>

				<section>
					<h3>Where Bits Become Breath!</h3>
					
					<div class="gsa-canvas-wrapper">
						<!-- Left Column -->
						<div class="left-panel">
							<div id="gsa-inputs" class="gsa-inputs-container"></div>
							<div id="step-count" class="iterations-container"></div>
						</div>
						
						<!-- Right Column -->
						<div id="canvas" class="canvas-container"></div>
					</div>

					<div>
						<button id="load-btn" class="button">Load</button>
						<button id="start-btn" class="button" disabled>Start</button>
						<button id="next-btn" class="button" disabled>Next</button>
						<button id="reset-btn" class="button" disabled>Reset</button>
					</div>
				</section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>

		<script type="module">
			import { load } from "./interpreter/interface.js";
			window.Interface = { load };
		</script>

		<script>
			let gsa = [
				0x00000107,
				0x00000000, 
				0x000000F0,
				0x00000000,
				0x00000AAB, 
				0x00000000,
				0x000000D0,
				0x000000F0
			];

			let corpse = [
				0x00000000,
				0x00000000, 
				0x00000000,
				0x00000000,
				0x00000000, 
				0x00000000,
				0x00000000,
				0x00000000
			];

			let count = 0;

			function renderCanvas() {
				const container = document.getElementById('canvas');
				container.innerHTML = '';

				// Create title
				const title = document.createElement('div');
				title.className = 'canvas-title';
				title.textContent = 'Canvas';
				container.appendChild(title);

				// Create cells
				gsa.forEach((row, rowIndex) => {
					// Get corpse data for this row
					const corpseRow = corpse[rowIndex];
					
					// Convert to 12-bit binary 
					const rowBits = row.toString(2).padStart(12, '0').slice(-12).split('').reverse().join('');
					const corpseBits = corpseRow.toString(2).padStart(12, '0').slice(-12).split('').reverse().join('');

					// Create cells
					for (let colIndex = 0; colIndex < 12; colIndex++) {
						const cell = document.createElement('div');
						cell.className = 'cell';
						
						if (corpseBits[colIndex] === '1') {
							cell.classList.add('corpse');
						} 

						else if (rowBits[colIndex] === '1') {
							cell.classList.add('alive');
						}

						container.appendChild(cell);
					}
				});
			}

			function renderGSA() {
				const container = document.getElementById('gsa-inputs');
				container.innerHTML = ''; 

				// Create title
				const title = document.createElement('div');
				title.className = 'gsa-title';
				title.textContent = 'GSA';
				container.appendChild(title);

				// Create input fields
				gsa.forEach((row, index) => {
					const input = document.createElement('input');
					input.className = 'input-field';
					input.value = `0x${row.toString(16).padStart(8, '0').toUpperCase()}`;
					input.dataset.row = index;
					container.appendChild(input);
				});
			}

			function renderIters() {
				const container = document.getElementById('step-count');
				container.innerHTML = '';
				
				// Create input field
				const input = document.createElement('input');
				input.className = 'input-field';
				input.id = 'stepCount';
				input.placeholder = 'Steps';
				container.appendChild(input);
			}

			function handleLoad() {
				document.getElementById('load-btn').disabled = true;
				document.getElementById('start-btn').disabled = false;
				document.getElementById('next-btn').disabled = false;
				document.getElementById('reset-btn').disabled = false;
				document.querySelectorAll('.input-field').forEach(input => {
					input.disabled = true;
				});

				const stepCount = document.getElementById('stepCount').value;
				
				// Get all GSA input values
				const gsaInputs = document.querySelectorAll('#gsa-inputs .input-field');
				const newGsa = Array.from(gsaInputs).map(input => {
					// Convert hex string to number 
					const hexValue = input.value.startsWith('0x') 
						? input.value.substring(2) 
						: input.value;
					return parseInt(hexValue, 16);
				});
	
				const result = window.Interface.load(newGsa, stepCount);
	
				// Update game state
				gsa = newGsa;
				corpse = result.corpse;
				count = result.days;

				console.log(corpse);
				
				// Update the canvas
				renderCanvas();
			}

			function handleStart() {
				document.getElementById('load-btn').disabled = true;
				document.getElementById('start-btn').disabled = true;
				document.getElementById('next-btn').disabled = true;
				document.getElementById('reset-btn').disabled = false;
			}

			function handleNext() {
				document.getElementById('load-btn').disabled = true;
				document.getElementById('start-btn').disabled = true;
				document.getElementById('next-btn').disabled = false;
				document.getElementById('reset-btn').disabled = false;
			}

			function handleReset() {
				document.getElementById('load-btn').disabled = false;
				document.getElementById('start-btn').disabled = true;
				document.getElementById('next-btn').disabled = true;
				document.getElementById('reset-btn').disabled = true;
				document.querySelectorAll('.input-field').forEach(input => {
					input.disabled = false;
				});
			}

			document.addEventListener('DOMContentLoaded', () => {
				// Button event listeners
				document.getElementById('load-btn').addEventListener('click', handleLoad);
				document.getElementById('start-btn').addEventListener('click', handleStart);
				document.getElementById('next-btn').addEventListener('click', handleNext);
				document.getElementById('reset-btn').addEventListener('click', handleReset);

				// Initialize Reveal
				Reveal.initialize({
					hash: true,
					plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
				}).then(() => {
					renderCanvas();
					renderGSA();
					renderIters();
				});
			});
		</script>
	</body>
</html>